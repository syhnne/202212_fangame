
## 持久化数据 ############################

## 要补充的时候，别忘了去game utter restart函数里面加东西！！！！！！！！！
default persistent.playthrough = 1
default persistent.lores = {'p03_read':False, 'p05_read':False, 'p08_read':False, 'p10_read':False, }
default persistent.unlock_gallery = False
default persistent.p01enter = False
default persistent.p03enter = False
default persistent.p04enter = False
default persistent.p05enter = False
default persistent.p08enter = False
default persistent.p10enter = False
default persistent.gamedata = {'load_times':0, 'playthrough1_fav':0, }
default persistent.seen_beginner_guide = False



## 定义角色和变量 ###############################################################

default pov_enable_c = True
default pov_enable_z = True
default z_name = '钟离'
default c_name = '达达利亚'
default npc1_name = '叶卡捷琳娜'
default npc2_name = '???'
default npc3_name = '??'
define test = Character('test')
define narrator = Character('', ctc = 'ctc')
define z = Character('z_name', dynamic=True, ctc='ctc', image='zhongli') ## 搞立绘的时候加个callback，那个角色回调函数，作出说话人高亮的效果
define c = Character('c_name', dynamic=True, ctc='ctc', image='childe')
define t = Character('旅行者', ctc = 'ctc')
define p = Character('派蒙', ctc = 'ctc')
define npc1 = Character('npc1_name', dynamic=True, ctc='ctc')
define npc2 = Character('npc2_name', dynamic=True, ctc='ctc')
define npc3 = Character('npc3_name', dynamic=True, ctc='ctc')


default pov = None ##方便起见，这东西是个布尔值，True是钟离视角，False是公子视角，一般理性而言，只有一周目开始前和四周目才会出现None
default time = 0 ## 由于时间那个dict不能用list作为value，只好把它做成一个整数，需要判断日期或者时间（指的是上午，下午，晚上那个时间），要用一个函数
default fav = 0 ## 这是好感度……这不是好感度，大概
default fav_history = []
default c08_saved = False
default wmt63_read = False
default nightlore = True ## 某些特殊剧情里面，晚上最好不要显示一天结束了睡个好觉那种画面，就把这个关掉。
default in_map = False
default choice_history = []

define wanmintangmenu = ['香嫩椒椒鸡','凉拌薄荷','来来菜','扣三丝','四方和平','兽肉薄荷卷','龙须面','米窝窝'] ## 鱼应该不算在钟离讨厌的那种海鲜范围内吧…算了，保险起见，天知道奥赛尔扔没扔过鱼（








## https://www.renpy.cn/doc/cds.html
# def parse_random(lexer):
#     subblock_lexer = lexer.subblock_lexer()
#     choices = []

#     while subblock_lexer.advance():
#         with subblock_lexer.catch_error():
#             statement = subblock_lexer.renpy_statement()
#             choices.append(statement)

#     return choices


# def next_random(choices):
#     return renpy.random.choice(choices)


# def lint_random(parsed_object):
#     for i in parsed_object:
#         renpy.check_text_tags(i.what)


# renpy.register_statement(
#     name="random",
#     block=True,
#     parse=parse_random,
#     next=next_random,
#     lint=lint_random,
# )


init python:

    ## 感谢ddlc，我直接对代码进行一个照搬。
    import random
    nonunicode = "¡¢£¤¥¦§¨©ª«¬®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿĀāĂăĄąĆćĈĉĊċČčĎďĐđĒēĔĕĖėĘęĚěĜĝĞğĠġĢģĤĥĦħĨĩĪīĬĭĮįİıĲĳĴĵĶķĸĹĺĻļĽľĿŀŁłŃńŅņŇňŉŊŋŌōŎŏŐőŒœŔŕŖŗŘřŚśŜŝŞşŠšŢţŤťŦŧŨũŪūŬŭŮůŰűŲųŴŵŶŷŸŹźŻżŽž"
    erererer = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'
    def glitchtext(length):
        output = ""
        for x in range(length):
            output += random.choice(nonunicode+erererer)
        return output
    gtext_mainmenu = glitchtext(12)

    ## 判断日期。举个例子，time的0,1,2分别指代第一天的早晨，下午，晚上；3,4,5分别指代第二天的早晨，下午，晚上……
    def date(time):
        if time>=0:
            date = (time//3)+1
        else:
            date = glitchtext(4)
        return date

    ## 判断时间。因为time这个词被我用过了，所以换成clock，不要在意这些细节。
    def clock(time):
        if time>=0:
            clock = time%3
        else:
            clock = glitchtext(4)
        return clock

    ## 返回时间段
    def clocktext(time):
        if time<0:
            return '???'
        elif time%3 == 0:
            return '上午'
        elif time%3 == 1:
            return '下午'
        else:
            return '晚上'
        
    ## 需要在文件保存界面读取的内容。文档里抄的，不知道为啥能跑：https://www.renpy.cn/doc/config.html#var-config.save_json_callbacks
    def jsoncallback(d):
        d["pov"] = pov
        d['timetext'] = '第'+str(date(time))+'天 '+clocktext(time)
        d['playthrough'] = persistent.playthrough
    config.save_json_callbacks.append(jsoncallback)

    ## 删存档，从ddlc搬来的
    def delete_all_saves():
        for savegame in renpy.list_saved_games(fast=True):
            renpy.unlink_save(savegame)

    ## 重置游戏数据
    def reset_game_data():
        delete_all_saves()
        persistent._clear(True)
        renpy.quit(relaunch=True)

    ## 从头再来，但不重置游戏数据
    def game_utter_restart():
        delete_all_saves()
        persistent.playthrough = 1
        persistent.lores = {'p03_read':False, 'p05_read':False, 'p08_read':False, 'p10_read':False, 'z09_read':False}
        persistent.p01enter = False
        persistent.p03enter = False
        persistent.p05enter = False
        persistent.p10enter = False
        persistent.seen_beginner_guide = False
        renpy.quit(relaunch=True)

    def events_unlocked():
        events_n = 0
        for key,value in persistent.lores.items():
            if value:
                events_n += 1
        if events_n == 0:
            return 0
        elif events_n < len(persistent.lores):
            return 1
        else:
            return 2

    def say_menu_callback(mode, old_modes):

        old = old_modes[0]

        if mode == "menu":
            if old == "say":
                pass

    def add_history(what='', who=None, kind='adv'):
        narrator.add_history(kind, who, what)

    def favp(amount, source='unknown'):
        global fav
        fav += amount
        x = str(time) + ':' + source + ' +' + str(amount)
        fav_history.append(x)
        x = '（好感度+' +str(amount)+ '）'
        add_history(x)

    def tp(amount):
        global time
        time += amount
        for i in range(amount):
            x=choice_history[-1]
            choice_history.append(x)



    

    



